# Исправление проблемы ложных срабатываний триггеров

## Описание проблемы

Бот иногда открывал/закрывал позиции без достижения тригерной цены. Это происходило из-за нескольких критических проблем в обработке котировок.

## Корневые причины

### 1. Использование устаревших котировок (Race Condition)

**Проблема:** Спред рассчитывался с использованием несинхронизированных цен двух ног.

**Сценарий:**
- Актив 1: свежая цена 100 (обновилась только что)
- Актив 2: устаревшая цена 95 (устарела 10 минут назад - перерыв в торгах)
- Спред = 100 × 1 - 95 × 1 = **5**
- Триггер для шорта: 3
- **Бот ошибочно открывает позицию** (5 > 3)

**Реальность:** Если бы был рынок по второй ноге, цена могла быть 98, и спред был бы 2 (триггер не сработал бы).

### 2. Неправильная обработка отсутствия ликвидности

**Проблема:** При отсутствии ликвидности в стакане функция `calcAvgPrice()` возвращала `null`, но:
- В ячейку записывалась **пустая строка** вместо очистки
- Старая цена могла оставаться в DOM
- Timestamp не обновлялся, но визуально цена могла выглядеть актуальной

**Код до исправления:**
```javascript
const price = calcAvgPrice(msg.orderbook, qty, side==='BUY');
priceCell.textContent = price ? price.toFixed(decimals): ''; // Записывает '', но не очищает timestamp!
```

### 3. Отсутствие проверки свежести котировок

**Проблема:** Не было никаких проверок, насколько давно обновлялись котировки. Бот мог торговать на основе данных 10-минутной давности.

## Решения

### ✅ 1. Очистка устаревших данных при отсутствии ликвидности

Теперь при получении пустого стакана или недостаточной ликвидности:
- Цена **очищается полностью**
- Timestamp **не обновляется** (для индикации устаревания)
- Логируется предупреждение

```javascript
if (price === null || price === undefined) {
    priceCell.textContent = '';
    // Не обновляем timestamp - оставляем старый для индикации устаревания
    console.warn(`No liquidity for ${idx===1?'asset_1':'asset_2'}: orderbook insufficient`);
} else {
    priceCell.textContent = price.toFixed(decimals);
    // Обновляем timestamp только при валидной цене
    row._md_dt_1 = timestamp; // или _md_dt_2
}
```

### ✅ 2. Проверка свежести котировок перед торговлей

Добавлена **обязательная проверка** возраста котировок в функции `checkRowForTrade()`:

```javascript
const maxAgeMs = 5000; // Настраивается через UI
const now = new Date().getTime();
const age1 = ts1 ? (now - ts1) : Infinity;
const age2 = ts2 ? (now - ts2) : Infinity;

if (age1 > maxAgeMs || age2 > maxAgeMs) {
    console.warn('Trade blocked: stale quotes', {...});
    // Блокируем торговлю и показываем ошибку
    return;
}
```

**Торговля блокируется если:**
- Любая из котировок старше порога (по умолчанию 5 секунд)
- Нет timestamp для любой из ног
- Котировка отсутствует (пустая ячейка)

### ✅ 3. Визуальная индикация устаревших котировок

Добавлена **автоматическая подсветка** устаревших данных:

- **Желтый фон** (warning): котировка старше 3 секунд
- **Красный фон** (error): котировка старше 5 секунд
- Подсвечиваются ячейки `price_1`, `price_2`, `md_dt_1`, `md_dt_2`

Проверка происходит **каждые 500мс** в фоновом режиме.

### ✅ 4. Настраиваемый порог свежести

Добавлен UI-элемент для настройки максимального возраста котировок:
- Расположен в Tab 5 (Pair arbitrage)
- По умолчанию: 5000 мс (5 секунд)
- Диапазон: 1000-30000 мс
- Применяется ко всем парам

## Технические детали

### Изменённые файлы

1. **frontend/static/main.js**
   - Функция `connectAsset()`: очистка цен при отсутствии ликвидности
   - Функция `checkRowForTrade()`: проверка свежести котировок
   - Добавлена функция мониторинга устаревших котировок (автоматическая подсветка)

2. **frontend/templates/index.html**
   - Добавлены CSS-классы: `.stale-quote`, `.stale-quote-warning`
   - Добавлен UI-элемент `max_quote_age` для настройки порога

### Логирование

Все блокировки торговли логируются в консоль:

```javascript
console.warn('Trade blocked: stale quotes', {
    age1_ms: 8000,
    age2_ms: 2000,
    max_age_ms: 5000,
    ts1: "2026-01-14T10:00:00.000Z",
    ts2: "2026-01-14T10:00:08.000Z"
});
```

## Рекомендации по использованию

### Настройка порога свежести

**Для высоколиквидных инструментов** (SBER, GAZP):
- Установите порог **2000-3000 мс**
- Котировки обновляются часто
- Малая задержка = меньше риска работы на устаревших данных

**Для среднеликвидных инструментов**:
- Используйте стандартные **5000 мс**
- Баланс между безопасностью и пропуском торговых возможностей

**Для низколиквидных инструментов**:
- Можно увеличить до **10000-15000 мс**
- Котировки обновляются редко
- Слишком короткий порог = постоянные блокировки

### Мониторинг

1. **Визуальный контроль**
   - Желтая подсветка = предупреждение (можно игнорировать кратковременно)
   - Красная подсветка = критично (торговля заблокирована)

2. **Колонка Error**
   - Показывает текст: `Stale quotes: age1=8s, age2=2s`
   - Автоматически очищается при восстановлении котировок

3. **Консоль браузера**
   - Все блокировки торговли логируются
   - Полезно для отладки и анализа

## Возможные сценарии блокировки

### 1. Перерыв в торгах
- **Причина:** Биржа приостановила торги по инструменту
- **Поведение:** Котировки перестают обновляться → красная подсветка → торговля блокируется
- **Решение:** Автоматическое, блокировка снимется при возобновлении торгов

### 2. Пропадание всех бидов/асков
- **Причина:** Момент низкой ликвидности, все заявки сняты
- **Поведение:** `calcAvgPrice()` возвращает `null` → цена очищается → торговля блокируется
- **Решение:** Автоматическое, при появлении котировок

### 3. Недостаточный объём в стакане
- **Причина:** Нужно купить 100 лотов, в стакане только 50
- **Поведение:** Как в п.2
- **Решение:** Либо дождаться ликвидности, либо уменьшить `qty_ratio`

### 4. Проблемы с WebSocket соединением
- **Причина:** Разрыв связи с QUIK или сервером
- **Поведение:** Котировки не обновляются → устаревание → блокировка
- **Решение:** Проверить heartbeat индикатор, переподключиться

## Тестирование

### Ручное тестирование

1. **Тест устаревания котировок:**
   - Запустите котировки для пары
   - Дождитесь стабильных цен
   - Остановите котировки для одной ноги (`get_mdata` = OFF)
   - Через 3 секунды → желтая подсветка
   - Через 5 секунд → красная подсветка + блокировка торговли
   - Проверьте колонку Error

2. **Тест отсутствия ликвидности:**
   - Выберите низколиквидный инструмент
   - Установите большой `qty_ratio` (больше доступного объёма)
   - Проверьте, что цена очищается (пустая ячейка)
   - Проверьте консоль на предупреждение "No liquidity"

3. **Тест восстановления:**
   - После блокировки запустите котировки снова
   - Проверьте, что подсветка исчезает
   - Проверьте, что ошибка "Stale quotes" очищается
   - Проверьте, что торговля возобновляется

### Live-тестирование

Используйте тестовую среду QUIK:
1. Настройте малый порог (2000 мс)
2. Выберите высоколиквидную пару
3. Включите `started` и мониторьте логи
4. Убедитесь, что нет ложных срабатываний

## Заключение

Исправление устраняет **критическую уязвимость** в логике торговли, которая могла привести к:
- Убыточным сделкам на основе устаревших данных
- Открытию позиций при отсутствии реального рынка
- Нарушению risk-менеджмента

**Все изменения обратно совместимы** и не требуют миграции БД.

