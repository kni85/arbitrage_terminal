# Исправление: настройки ботов не сохранялись после обновления

## Описание проблемы

После коммита с исправлением устаревших котировок настройки ботов перестали сохраняться. При перезагрузке страницы все настройки сбрасывались в исходное состояние.

## Корневая причина

При добавлении проверки свежести котировок были введены новые поля `row._md_dt_1` и `row._md_dt_2` для хранения timestamp'ов котировок. Эти значения используются для проверки возраста котировок в функции `checkRowForTrade()`.

**Проблема:** При загрузке данных из БД/localStorage функция `addPairsRow()` **не восстанавливала** значения `row._md_dt_1` и `row._md_dt_2`.

### Последствия:

1. **При загрузке страницы:**
   ```javascript
   row._md_dt_1 = undefined  // НЕ восстановлено из БД!
   row._md_dt_2 = undefined  // НЕ восстановлено из БД!
   ```

2. **При проверке свежести котировок:**
   ```javascript
   const ts1 = row._md_dt_1 ? new Date(row._md_dt_1).getTime() : 0;
   // ts1 = 0 (потому что row._md_dt_1 === undefined)
   
   const age1 = ts1 ? (now - ts1) : Infinity;
   // age1 = Infinity (потому что ts1 === 0)
   
   if (age1 > maxAgeMs) {  // Infinity > 5000 === true
       return; // БЛОКИРОВКА ТОРГОВЛИ!
   }
   ```

3. **Результат:** Все боты с включённым `started` **немедленно блокировались** из-за "устаревших котировок" (age = Infinity).

4. **Видимые симптомы:**
   - Настройки как будто сбрасывались (на самом деле боты просто не работали)
   - В консоли: `Trade blocked: stale quotes, age1=Infinity, age2=Infinity`
   - Красная подсветка на всех котировках (если `get_mdata` включён)

## Исправление 1: Восстановление timestamp'ов при загрузке

**Файл:** `frontend/static/main.js`

**Место:** Функция `addPairsRow()`, после создания всех ячеек

**Добавлено:**
```javascript
// Restore timestamp values from data object (needed for stale quote checking)
if(data && typeof data === 'object' && !Array.isArray(data)) {
    if(data.md_dt_1) {
        row._md_dt_1 = data.md_dt_1;
    }
    if(data.md_dt_2) {
        row._md_dt_2 = data.md_dt_2;
    }
}

// initial hit price
updateHitPrice(row);
return row;
```

**Эффект:**
- При загрузке из БД timestamp'ы корректно восстанавливаются
- Проверка свежести работает с реальными значениями, а не с `undefined`
- Боты могут работать с сохранёнными timestamp'ами до получения новых котировок

## Исправление 2: Подсветка только активных котировок

**Файл:** `frontend/static/main.js`

**Место:** Фоновая функция `checkStaleQuotes()`

**Проблема:** Подсветка устаревших котировок работала **всегда**, даже для строк с выключенным `get_mdata`. Это приводило к красным ячейкам по всей таблице после загрузки страницы (т.к. timestamp'ы из БД устарели).

**Добавлено:**
```javascript
// Подсветка только если get_mdata активен
const getMdataActive = getMdataCell && 
                       getMdataCell.querySelector('input') && 
                       getMdataCell.querySelector('input').checked;

// Если get_mdata выключен - очищаем подсветку
if (!getMdataActive) {
    price1Cell.classList.remove('stale-quote', 'stale-quote-warning');
    price2Cell.classList.remove('stale-quote', 'stale-quote-warning');
    if (mdDt1Cell) mdDt1Cell.classList.remove('stale-quote', 'stale-quote-warning');
    if (mdDt2Cell) mdDt2Cell.classList.remove('stale-quote', 'stale-quote-warning');
    continue;
}
```

**Эффект:**
- Подсветка устаревших котировок работает **только** для строк с включённым `get_mdata`
- После загрузки страницы нет ложных красных подсветок
- Визуально чище и понятнее

## Логика работы после исправления

### Сценарий 1: Загрузка сохранённых настроек

```
1. Страница загружается
2. backendSync() загружает данные из БД
3. restorePairsTable() вызывает addPairsRow(data) для каждой строки
4. addPairsRow() восстанавливает:
   - Все видимые данные (asset_1, price, target_qty, и т.д.)
   - row._md_dt_1 = data.md_dt_1  ← ИСПРАВЛЕНО!
   - row._md_dt_2 = data.md_dt_2  ← ИСПРАВЛЕНО!
5. Если get_mdata = true → подключаются WebSocket'ы
6. При получении новых котировок timestamp'ы обновляются
7. Проверка свежести работает корректно
```

### Сценарий 2: Работа с устаревшими timestamp'ами из БД

```
Дано:
- Бот был остановлен вчера в 15:00
- В БД сохранены md_dt_1 = "2026-01-13T15:00:00Z"
- Сегодня 14:00, прошло 23 часа

При загрузке:
1. row._md_dt_1 = "2026-01-13T15:00:00Z"  ← Восстановлено из БД
2. Если get_mdata = false:
   - Подсветка НЕ работает (не мешает)
   - checkRowForTrade() не вызывается (бот выключен)
3. Если get_mdata = true:
   - Подсветка показывает красный цвет (корректно - данные устарели)
   - При получении первых котировок timestamp'ы обновляются
   - Подсветка становится нормальной
4. Если started = true (бот включён):
   - Без свежих котировок торговля ЗАБЛОКИРОВАНА (корректно!)
   - После получения свежих котировок торговля разрешается
```

### Сценарий 3: Создание новой пары

```
1. Добавляется новая строка
2. row._md_dt_1 = undefined (нет данных)
3. row._md_dt_2 = undefined
4. Включается get_mdata
5. Приходят первые котировки
6. row._md_dt_1 = текущий timestamp
7. row._md_dt_2 = текущий timestamp
8. Торговля разрешена (если started = true и триггер сработал)
```

## Тестирование

### Тест 1: Сохранение и загрузка настроек

1. Создать пару с настройками
2. Запустить бота (started = true)
3. Обновить страницу (F5)
4. **Ожидаемый результат:** 
   - Все настройки сохранились
   - Бот в состоянии "started = true"
   - Котировки подключаются автоматически (если get_mdata = true)

### Тест 2: Устаревшие timestamp'ы

1. Запустить бота, получить котировки
2. Остановить сервер на несколько минут
3. Перезагрузить страницу
4. **Ожидаемый результат:**
   - Настройки загрузились
   - Timestamp'ы из БД восстановлены
   - Красная подсветка (если get_mdata = true)
   - Торговля заблокирована до получения свежих котировок

### Тест 3: Подсветка только активных

1. Создать 5 пар
2. Включить get_mdata только для 2 из них
3. Обновить страницу
4. **Ожидаемый результат:**
   - Красная подсветка только на 2 парах с get_mdata = true
   - Остальные 3 пары БЕЗ подсветки

## Изменённые файлы

1. **frontend/static/main.js**
   - Функция `addPairsRow()`: добавлено восстановление `row._md_dt_1` и `row._md_dt_2`
   - Функция `checkStaleQuotes()`: подсветка только при `get_mdata = true`

## Команда для коммита

```bash
git add frontend/static/main.js BUGFIX_SETTINGS_RESTORE.md
git commit -m "Исправлена загрузка настроек ботов после обновления

Проблема: после добавления проверки свежести котировок настройки ботов 
не восстанавливались корректно при перезагрузке страницы.

Причина: timestamp'ы котировок (md_dt_1, md_dt_2) не восстанавливались 
из БД в переменные row._md_dt_1 и row._md_dt_2, что приводило к 
age=Infinity и блокировке всех ботов.

Исправления:
- addPairsRow() теперь восстанавливает row._md_dt_1 и row._md_dt_2 из данных БД
- Подсветка устаревших котировок работает только при get_mdata=true
- Корректная работа с устаревшими timestamp'ами из БД

Тестирование: создание/загрузка/перезагрузка настроек работает корректно."
```
